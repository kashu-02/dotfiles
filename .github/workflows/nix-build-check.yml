name: "Nix Build Check"

on:
  workflow_run:
    workflows: ["Nix Lint", "Format Check"]
    types:
      - completed
    branches:
      - main
  pull_request:
  push:
    branches:
      - main

jobs:
  # Check if all prerequisite workflows succeeded
  check-prerequisites:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_run' }}
    outputs:
      should-run: ${{ steps.check.outputs.result }}
    steps:
      - name: Check if all required workflows succeeded
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // If this workflow was triggered by workflow_run, check if it was successful
            if (context.eventName === 'workflow_run') {
              const conclusion = context.payload.workflow_run.conclusion;
              if (conclusion !== 'success') {
                core.notice(`Workflow ${context.payload.workflow_run.name} did not succeed: ${conclusion}`);
                return 'false';
              }

              // Check if both required workflows have succeeded
              const workflows = ['Nix Lint', 'Format Check'];
              const { owner, repo } = context.repo;
              const sha = context.payload.workflow_run.head_sha;

              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                head_sha: sha,
                status: 'completed',
              });

              let allSucceeded = true;
              for (const workflowName of workflows) {
                const run = runs.data.workflow_runs.find(r => r.name === workflowName);
                if (!run) {
                  core.notice(`Workflow ${workflowName} has not run yet`);
                  allSucceeded = false;
                } else if (run.conclusion !== 'success') {
                  core.notice(`Workflow ${workflowName} conclusion: ${run.conclusion}`);
                  allSucceeded = false;
                }
              }

              return allSucceeded ? 'true' : 'false';
            }
            return 'true';

  nix-build:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: |
      always() &&
      (needs.check-prerequisites.result == 'skipped' || needs.check-prerequisites.outputs.should-run == 'true')
    strategy:
      matrix:
        config:
          - dev-nix
          - kashu-lab-nixos
          - l390-laptop
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Build NixOS configuration for ${{ matrix.config }}
        run: |
          nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel --print-build-logs

  nix-darwin-build:
    runs-on: macos-latest
    needs: check-prerequisites
    if: |
      always() &&
      (needs.check-prerequisites.result == 'skipped' || needs.check-prerequisites.outputs.should-run == 'true')
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Build Darwin configuration
        run: |
          nix build .#darwinConfigurations.Shunsukes-MacBook-Air.system --print-build-logs

  nix-flake-check:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: |
      always() &&
      (needs.check-prerequisites.result == 'skipped' || needs.check-prerequisites.outputs.should-run == 'true')
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/determinate-nix-action@v3

      - name: Check flake
        run: |
          nix flake check --print-build-logs
